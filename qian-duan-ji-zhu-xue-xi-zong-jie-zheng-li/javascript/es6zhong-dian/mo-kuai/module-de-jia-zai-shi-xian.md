# Module 的加载实现
## 一 在浏览器中加载 ES6 模块

### 1. 浏览器加载js的传统方法
HTML中，浏览器通过`<script>`标签加载 JS 脚本。

**浏览器默认同步加载 JS 脚本，即渲染引擎遇到`<script>`标签就会停下来，等到执行完脚本，再继续向下渲染**。如果是**外部脚本，还须加入脚本下载时间**。

如**脚本体积很大**，下载和执行时间就会很长，**易造成浏览器堵塞，“卡死”，没有任何响应**。这显然是很不好的体验，**所以浏览器允许脚本异步加载**，下面就是**两种异步加载的语法**：

** 即 `<script>`标签打开defer或async属性**，脚本就会异步加载。**渲染引擎遇到此标签时，就开始下载外部脚本，但不会等它下载和执行完，而是直接执行后面的代码**。

#### defer与async的区别：
defer要等整个页面在内存中正常渲染结束（DOM 结构完全生成，以及其他脚本执行完成），才会执行；
async一旦下载完，渲染引擎就会中断渲染，执行这个脚本以后，再继续渲染。

一句话，**defer是“渲染完再执行”，async是“下载完就执行”**。

另外，**如有多个defer脚本，会按在页面出现的顺序加载，而多个async脚本则不能保证加载顺序（因为谁先下载完谁就执行）**。

### 2. 加载ES6模块代码的规则

**浏览器加载 ES6 模块，也使用`<script>`标签，但要加入type="module"属性**。



```
<script type="module" src="./foo.js"></script>
```



上面代码在网页中插入模块foo.js，**由于type属性设为module，所以浏览器知道这是一个 ES6 模块**。

**浏览器对于带有type="module"的<script>，都是异步加载，不会造成堵塞浏览器，即等整个页面渲染完，再执行模块脚本，等同于打开了<script>标签的defer属性**。

如果网页有多个`<script type="module">`，它们会按照在页面出现的顺序依次执行。

`<script>`标签的async属性也可以打开，这时只要加载完成，渲染引擎就会中断渲染立即执行。执行完成后，再恢复渲染。`<script type="module">`也就不会按照在页面出现的顺序执行，而是只要该模块下载完成，就执行该模块。

ES6 模块代码也允许内嵌在网页中，语法行为与加载外部脚本完全一致：


```
<script type="module">
  import utils from "./utils.js";

  // other code
</script>
```

#### 对于外部的模块脚本（上例是通过type="module" 引用foo.js文件），有几点需注意：

代码在模块作用域之中运行，而非在全局作用域运行。模块内部的顶层变量，外部不可见；

模块脚本自动采用严格模式；

模块中，可使用import命令加载其他模块（.js后缀不可省，需提供绝对或相对 URL），也可用export命令输出对外接口；

模块中，顶层this关键字返回undefined，而不是指向window。即在模块顶层使用this关键字，是无意义的；

同一模块如果加载多次，将只执行一次。



## 二 ES6 与 CommonJS 模块的差异

### 两个重大差异：

**CommonJS 模块输出的是一个值的拷贝，ES6 模块输出的是值的引用**。
**CommonJS 模块是运行时加载，ES6 模块是编译时输出接口**。

第二个差异是因为 CommonJS 加载的是一个对象（即module.exports属性），该对象只有在脚本运行完才会生成。而 ES6 模块不是对象，它的对外接口只是一种静态定义，在代码静态解析阶段就会生成。

### ES6 模块的运行机制与 CommonJS 不一样：

JS 引擎对脚本静态分析时，遇到**ES6模块加载命令import，就会生成一个只读引用**。等到脚本真正执行时，再根据这个只读引用，到被加载的那个模块里面去取值。

**ES6 的import有点像 Unix 系统的“符号连接”，原始值变了，import加载的值也会跟着变。因此，ES6 模块是动态引用，并且不会缓存值**，模块里面的变量绑定其所在的模块。

由于 ES6 输入的模块变量，只是一个“符号连接”，所以这个变量是只读的，对它进行重新赋值会报错。

**export通过接口，输出的是同一个值。不同的脚本加载这个接口，得到的都是同样的实例**。

例子略，具体可参考最下面的链接。

## 三 Node 中加载 ES6 模块



## 循环加载
## ES6 模块的转码

## 参考
http://es6.ruanyifeng.com/#docs/module-loader

